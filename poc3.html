<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hero Draft & Battle</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Base Styles --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: white;
            overflow-x: hidden;
        }
        .font-cinzel { font-family: 'Cinzel', serif; }

        /* --- Scene Containers --- */
        .scene {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            transition: opacity 0.7s ease-out, transform 0.7s ease-out;
        }
        .scene.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute;
            width: 100%;
            left: 0;
            top: 0;
        }

        /* --- Booster Pack Scene --- */
        .booster-pack, .weapon-pack {
            border-radius: 1rem;
            border: 3px solid #fde047;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .booster-pack {
            width: 280px;
            height: 400px;
            background: linear-gradient(45deg, #4c1d95, #be185d);
            box-shadow: 0 0 30px rgba(253, 224, 71, 0.4), inset 0 0 20px rgba(0,0,0,0.5);
        }
         .weapon-pack {
            width: 350px;
            height: 280px;
            background: linear-gradient(135deg, #422d1a, #854d0e);
            box-shadow: 0 0 30px rgba(133, 77, 14, 0.6), inset 0 0 20px rgba(0,0,0,0.5);
        }

        .booster-pack:hover, .weapon-pack:hover {
            transform: scale(1.05) translateY(-10px);
        }

        /* Pack opening animations */
        .opening {
            animation: shake-and-glow 1.5s ease-in-out, fade-out 0.5s ease-in 1.5s forwards;
        }
        @keyframes shake-and-glow {
            0%, 100% { transform: scale(1.0) rotate(0deg); }
            10%, 30%, 50%, 70%, 90% { transform: scale(1.1) rotate(-2deg); }
            20%, 40%, 60%, 80% { transform: scale(1.1) rotate(2deg); }
            50% { box-shadow: 0 0 80px rgba(253, 224, 71, 0.9); }
        }
        @keyframes fade-out {
            to { transform: scale(1.5); opacity: 0; }
        }
        
        /* --- Draft Scene --- */
        .draft-pool { display: grid; grid-template-columns: repeat(1, 1fr); gap: 2rem; width: 100%; max-width: 1400px; justify-items: center; }
        @media (min-width: 768px) { .draft-pool { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1380px) { .draft-pool { grid-template-columns: repeat(4, 1fr); } }
        .weapon-draft-pool { grid-template-columns: repeat(1, 1fr); }
        @media (min-width: 1024px) { .weapon-draft-pool { grid-template-columns: repeat(3, 1fr); } }

        /* --- Detail Card Styles --- */
        .hero-card-container { width: 320px; height: 450px; position: relative; perspective: 1500px; }
        .hero-card { box-shadow: 0 10px 25px rgba(0,0,0,0.5); transform-style: preserve-3d; cursor: pointer; border: 4px solid transparent; transition: all 0.3s; width: 100%; height: 100%; position: absolute; border-radius: 1.25rem; background-size: cover; background-position: center; overflow: hidden; }
        .hero-card:hover { transform: translateY(-10px) scale(1.05); }
        .hero-card.selected { border-color: #f59e0b; box-shadow: 0 0 25px #f59e0b, 0 10px 30px rgba(0,0,0,0.7); transform: translateY(-5px) scale(1.02); }
        .hero-card.disabled { opacity: 0.5; pointer-events: none; }
        .hero-card.common { border-color: #9ca3af; }
        .hero-card.uncommon { border-color: #22c55e; }
        .hero-card.rare { border-color: #f59e0b; }
        .hero-card.ultra-rare { border-color: #a78bfa; }
        .shimmer-effect { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(110deg, rgba(255, 255, 255, 0) 40%, rgba(255, 255, 255, 0.25) 50%, rgba(255, 255, 255, 0) 60%); background-size: 200% 100%; animation: shimmer 4s infinite linear; z-index: 2; pointer-events: none; }
        @keyframes shimmer { from { background-position: 200% 0; } to { background-position: -200% 0; } }
        .hero-art { position: absolute; top: 11%; left: 10%; width: 80%; height: 45%; background-size: cover; background-position: top center; border-radius: 0.75rem; border: 2px solid #71717a; box-shadow: 0 0 10px rgba(0,0,0,0.8) inset; }
        .hero-name { position: absolute; top: 5%; width: 100%; text-align: center; font-size: 1.5rem; font-weight: 700; text-shadow: 2px 2px 4px #000; }
        .hero-stats { position: absolute; bottom: 30%; width: 100%; display: flex; justify-content: space-around; padding: 0 1rem; }
        .stat-block { text-align: center; }
        .stat-value { font-size: 1.25rem; font-weight: 600; }
        .stat-label { font-size: 0.75rem; text-transform: uppercase; opacity: 0.8; }
        .hero-abilities { position: absolute; bottom: 5%; width: 100%; padding: 0 1.5rem; list-style: none; font-size: 0.875rem; }
        .hero-abilities li { position: relative; margin-bottom: 0.25rem; padding: 0.25rem; border-radius: 0.25rem; }
        .tooltip { visibility: hidden; opacity: 0; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background-color: #1f2937; color: white; padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid #4b5563; font-size: 0.8rem; width: max-content; max-width: 220px; z-index: 100; transition: opacity 0.3s; pointer-events: none; margin-bottom: 8px; }
        .hero-abilities li:hover .tooltip { visibility: visible; opacity: 1; }

        /* --- Confirmation Bar --- */
        .confirmation-bar { position: fixed; bottom: -100px; left: 0; width: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); padding: 1rem; display: flex; justify-content: center; align-items: center; transition: bottom 0.5s ease-in-out; z-index: 100; }
        .confirmation-bar.visible { bottom: 0; }
        .confirm-button { background-color: #f59e0b; color: #111827; padding: 0.75rem 2rem; border-radius: 0.5rem; font-size: 1.125rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .confirm-button:hover { background-color: #fbbf24; }
        
        /* --- Battle Scene Styles --- */
        #battle-scene-background {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center; z-index: -1; filter: blur(4px) brightness(0.7);
        }
        .battle-arena { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; width: 100%; max-width: 1200px; padding: 2rem; align-items: center; }
        .team-container { display: flex; flex-direction: column; align-items: center; gap: 2rem; }
        .compact-card { width: 150px; height: 210px; border-radius: 0.5rem; background-color: #2d3748; position: relative; overflow: visible; display: flex; flex-direction: column; box-shadow: 0 4px 12px rgba(0,0,0,0.5); transition: transform 0.3s ease; }
        .compact-card.common { border: 2px solid #9ca3af; }
        .compact-card.uncommon { border: 2px solid #22c55e; }
        .compact-card.rare { border: 2px solid #a88532; }
        .compact-card.ultra-rare { border: 2px solid #a78bfa; }
        .compact-art { height: 60%; width: 100%; background-size: cover; background-position: center; border-top-left-radius: 0.3rem; border-top-right-radius: 0.3rem; }
        .compact-info { flex-grow: 1; padding: 0.5rem; display: flex; flex-direction: column; justify-content: space-between; }
        .compact-name { font-size: 1rem; font-weight: 700; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .hp-text { font-size: 0.75rem; text-align: center; opacity: 0.8; margin-bottom: 0.25rem; }
        .compact-hp-bar-container { width: 100%; height: 8px; background-color: #1f2937; border-radius: 4px; overflow: hidden; }
        .compact-hp-bar { height: 100%; width: 100%; background-color: #48bb78; border-radius: 4px; transition: width 0.5s ease; }
        .compact-card.is-attacking { transform: scale(1.1) translateY(-10px); z-index: 50; }
        .compact-card.is-taking-damage { animation: take-damage 0.07s ease; }
        @keyframes take-damage { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .compact-card.is-defeated { opacity: 0.4; filter: grayscale(100%); transform: translateY(20px) scale(0.9); }
        .damage-popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; font-weight: 700; color: #ef4444; text-shadow: 1px 1px 2px black; animation: popup-and-fade 0.25s ease-out forwards; pointer-events: none; z-index: 100; }
        @keyframes popup-and-fade { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -150%) scale(1.2); opacity: 0; } }
        .status-icon-container { position: absolute; top: -10px; right: -10px; display: flex; gap: 0.25rem; }
        .status-icon { width: 24px; height: 24px; background-color: rgba(0,0,0,0.7); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; border: 1px solid white; }
        #battle-log { position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); padding: 0.75rem; border-radius: 0.5rem; text-align: center; font-size: 1.1rem; transition: opacity 0.5s; }
        
        #speed-cycle-button {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4b5563;
            border: 1px solid #6b7280;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            z-index: 150;
            transition: background-color 0.2s;
        }
        #speed-cycle-button:hover {
            background-color: #6b7280;
        }

        #end-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(8px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; opacity: 0; transition: opacity 1s ease; pointer-events: none; }
        #end-screen.visible { opacity: 1; pointer-events: all; }
        #end-screen-result-text { font-size: 6rem; font-weight: 700; text-transform: uppercase; }
        #end-screen.victory #end-screen-result-text { color: #fde047; text-shadow: 0 0 20px #f59e0b; }
        #end-screen.defeat #end-screen-result-text { color: #ef4444; text-shadow: 0 0 20px #b91c1c; }
        #play-again-button { margin-top: 2rem; background-color: #fde047; color: #111827; padding: 1rem 3rem; border: none; border-radius: 0.5rem; font-size: 1.5rem; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        #play-again-button:hover { transform: scale(1.1); }
        #end-screen-results { display: flex; gap: 1rem; margin-top: 2rem; }

    </style>
</head>
<body>

    <!-- Scene 1: Hero Pack -->
    <div id="pack-scene" class="scene">
        <h1 id="pack-scene-title" class="text-5xl font-cinzel tracking-wider mb-8 text-center">Open Your Hero Pack</h1>
        <div id="booster-pack" class="booster-pack">
            <i class="fa-solid fa-user-group text-8xl text-yellow-200 opacity-80"></i>
        </div>
        <p id="pack-scene-instructions" class="text-lg text-gray-400 mt-8">Click the pack to begin.</p>
    </div>

    <!-- Scene 2: Hero Draft -->
    <div id="draft-scene" class="scene hidden">
        <header class="text-center mb-8">
            <h1 id="draft-scene-title" class="text-5xl font-cinzel tracking-wider">Your Heroes</h1>
            <p id="draft-instructions" class="text-lg text-gray-400 mt-2">Choose a hero for your team.</p>
        </header>
        <div id="draft-pool" class="draft-pool"></div>
    </div>
    
    <!-- Scene 3: Weapon Draft -->
    <div id="weapon-scene" class="scene hidden">
         <header class="text-center mb-8">
            <h1 id="weapon-scene-title" class="text-5xl font-cinzel tracking-wider">Choose a Weapon</h1>
            <p id="weapon-instructions" class="text-lg text-gray-400 mt-2">Select one weapon.</p>
        </header>
        <div id="weapon-pack" class="weapon-pack">
             <i class="fa-solid fa-box text-8xl text-yellow-200 opacity-80"></i>
        </div>
        <div id="weapon-draft-pool" class="draft-pool weapon-draft-pool mt-8" style="display: none;"></div>
    </div>

    <!-- Scene 4: Battle -->
    <div id="battle-scene" class="scene hidden">
        <div id="battle-scene-background"></div>
        <button id="speed-cycle-button">Speed: 1x</button>
        <div class="battle-arena">
            <div id="player-team-container" class="team-container"></div>
            <div id="enemy-team-container" class="team-container"></div>
        </div>
        <div id="battle-log">The battle is about to begin...</div>
        <div id="end-screen">
            <h1 id="end-screen-result-text"></h1>
            <div id="end-screen-results"></div>
            <button id="play-again-button">Play Again</button>
        </div>
    </div>

    <!-- Floating Confirmation Bar -->
    <div id="confirmation-bar" class="confirmation-bar">
        <button id="confirm-draft" class="confirm-button">Start Battle</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA ---
            const allPossibleHeroes = [
                // Warrior Class
                { type: 'hero', id: 1, name: 'Recruit', rarity: 'Common', art: 'https://placehold.co/150x126/6b7280/FFFFFF?text=Recruit', hp: 18, attack: 3, abilities: [{ name: 'Basic Strike', description: 'Deals 3 damage.' }] },
                { type: 'hero', id: 2, name: 'Squire', rarity: 'Uncommon', art: 'https://placehold.co/150x126/78716c/FFFFFF?text=Squire', hp: 22, attack: 5, abilities: [{ name: 'Power Strike', description: 'Deals 5 damage.' }, { name: 'Fortify', description: 'Passive: Reduce all incoming damage by 1.' }] },
                { type: 'hero', id: 3, name: 'Warrior', rarity: 'Rare', art: 'https://placehold.co/150x126/57534e/FFFFFF?text=Warrior', hp: 25, attack: 7, abilities: [{ name: 'Shield Bash', description: 'Deals 1 damage and Stuns the target for 1 turn.' }, { name: 'Power Strike', description: 'Deals 7 damage.' }] },
                { type: 'hero', id: 4, name: 'Champion', rarity: 'Ultra Rare', art: 'https://placehold.co/150x126/1c1917/FFFFFF?text=Champ', hp: 30, attack: 10, abilities: [{ name: 'Whirlwind', description: 'Deals 4 damage to all enemies.' }, { name: 'Execute', description: 'Deals 10 damage to a single target.' }] },
                
                // Mage Class
                { type: 'hero', id: 5, name: 'Apprentice', rarity: 'Common', art: 'https://placehold.co/150x126/93c5fd/1e3a8a?text=Apprentice', hp: 15, attack: 2, abilities: [{ name: 'Magic Bolt', description: 'Deals 2 damage.' }] },
                { type: 'hero', id: 6, name: 'Mage', rarity: 'Rare', art: 'https://placehold.co/150x126/60a5fa/1e3a8a?text=Mage', hp: 20, attack: 4, abilities: [{ name: 'Fireball', description: 'Deals 8 damage.' }, { name: 'Frost Armor', description: 'Gain 5 temporary HP.' }] },
                
                // Rogue Class
                { type: 'hero', id: 7, name: 'Thief', rarity: 'Common', art: 'https://placehold.co/150x126/a78bfa/4c1d95?text=Thief', hp: 16, attack: 4, abilities: [{ name: 'Quick Stab', description: 'Deals 4 damage.' }] },
                { type: 'hero', id: 8, name: 'Assassin', rarity: 'Rare', art: 'https://placehold.co/150x126/8b5cf6/4c1d95?text=Assassin', hp: 21, attack: 8, abilities: [{ name: 'Backstab', description: 'Deals 12 damage if target is above 50% HP.' }, { name: 'Vanish', description: 'Become untargetable for 1 turn.' }] },
                
                // Priest Class
                { type: 'hero', id: 9, name: 'Acolyte', rarity: 'Common', art: 'https://placehold.co/150x126/fef08a/b45309?text=Acolyte', hp: 17, attack: 2, abilities: [{ name: 'Minor Heal', description: 'Restores 4 HP to an ally.' }] },
                { type: 'hero', id: 10, name: 'Priest', rarity: 'Uncommon', art: 'https://placehold.co/150x126/fde047/b45309?text=Priest', hp: 21, attack: 3, abilities: [{ name: 'Heal', description: 'Restores 8 HP.' }, { name: 'Smite', description: 'Deals 3 damage.' }] },

                // Ranger Class
                { type: 'hero', id: 11, name: 'Hunter', rarity: 'Common', art: 'https://placehold.co/150x126/86efac/15803d?text=Hunter', hp: 17, attack: 4, abilities: [{ name: 'Aimed Shot', description: 'Deals 4 damage.' }] },
                { type: 'hero', id: 12, name: 'Ranger', rarity: 'Uncommon', art: 'https://placehold.co/150x126/4ade80/15803d?text=Ranger', hp: 22, attack: 6, abilities: [{ name: 'Rapid Fire', description: 'Attacks twice for 3 damage each.' }, { name: 'Tracking Shot', description: 'Target takes +1 damage from all sources.' }] },

                // Paladin Class
                { type: 'hero', id: 13, name: 'Vindicator', rarity: 'Rare', art: 'https://placehold.co/150x126/fef9c3/a16207?text=Vindicator', hp: 28, attack: 5, abilities: [{ name: 'Divine Strike', description: 'Deals 5 damage and heals self for 2.' }] },
                { type: 'hero', id: 14, name: 'Paladin', rarity: 'Ultra Rare', art: 'https://placehold.co/150x126/fefce8/a16207?text=Paladin', hp: 32, attack: 8, abilities: [{ name: 'Holy Smite', description: 'Deals 8 damage and heals all allies for 2.' }, {name: 'Divine Shield', description: 'Become immune to damage for 1 turn.'}] },

                // Barbarian Class
                { type: 'hero', id: 15, name: 'Brute', rarity: 'Common', art: 'https://placehold.co/150x126/fca5a5/991b1b?text=Brute', hp: 20, attack: 4, abilities: [{ name: 'Heavy Swing', description: 'Deals 4 damage.'}] },
                { type: 'hero', id: 16, name: 'Barbarian', rarity: 'Uncommon', art: 'https://placehold.co/150x126/f87171/991b1b?text=Barbarian', hp: 26, attack: 6, abilities: [{ name: 'Reckless Attack', description: 'Deals 10 damage, but take 3 damage.'}, {name: 'Enrage', description: '+2 Attack for 3 turns.'}] },

                // Monk Class
                { type: 'hero', id: 17, name: 'Initiate', rarity: 'Common', art: 'https://placehold.co/150x126/fdba74/c2410c?text=Initiate', hp: 16, attack: 4, abilities: [{ name: 'Swift Fist', description: 'Deals 4 damage.'}] },
                { type: 'hero', id: 18, name: 'Monk', rarity: 'Rare', art: 'https://placehold.co/150x126/fb923c/c2410c?text=Monk', hp: 24, attack: 5, abilities: [{ name: 'Flurry of Blows', description: 'Attack 3 times for 2 damage each.'}, {name: 'Stunning Palm', description: 'Has a 25% chance to Stun.'}] },
                
                // Druid Class
                { type: 'hero', id: 19, name: 'Shapeshifter', rarity: 'Uncommon', art: 'https://placehold.co/150x126/a3e635/3f6212?text=Shapeshifter', hp: 23, attack: 5, abilities: [{ name: 'Bear Form', description: 'Gain +5 HP and +2 Attack for 2 turns.'}] },
                { type: 'hero', id: 20, name: 'Archdruid', rarity: 'Ultra Rare', art: 'https://placehold.co/150x126/84cc16/3f6212?text=Archdruid', hp: 28, attack: 7, abilities: [{ name: 'Entangling Roots', description: 'Target cannot attack for 2 turns.'}, { name: 'Starfall', description: 'Deals 3 damage to all enemies for 2 turns.'}] },

                // Warlock Class
                { type: 'hero', id: 21, name: 'Cultist', rarity: 'Common', art: 'https://placehold.co/150x126/c084fc/581c87?text=Cultist', hp: 16, attack: 3, abilities: [{ name: 'Shadow Bolt', description: 'Deals 3 damage.'}] },
                { type: 'hero', id: 22, name: 'Warlock', rarity: 'Rare', art: 'https://placehold.co/150x126/a855f7/581c87?text=Warlock', hp: 22, attack: 6, abilities: [{ name: 'Life Drain', description: 'Deals 5 damage and heal for the same amount.'}, { name: 'Curse of Weakness', description: 'Target deals -2 damage for 3 turns.'}] },

                // Bard Class
                { type: 'hero', id: 23, name: 'Minstrel', rarity: 'Uncommon', art: 'https://placehold.co/150x126/f9a8d4/9d2667?text=Minstrel', hp: 20, attack: 2, abilities: [{ name: 'Song of Vigor', description: 'All allies gain +1 attack.'}, { name: 'Dissonance', description: 'Confuses target, 50% chance to attack ally.'}] },
            ];
            const allPossibleWeapons = [
                { type: 'weapon', id: 101, name: 'Iron Sword', rarity: 'Common', art: 'https://placehold.co/256x202/6b7280/FFFFFF?text=Sword', damage: 2, abilities: [{ name: 'Cleave', description: 'Deals 50% damage to the second target.' }] },
                { type: 'weapon', id: 102, name: 'Mage Staff', rarity: 'Uncommon', art: 'https://placehold.co/256x202/5b21b6/FFFFFF?text=Staff', damage: 1, abilities: [{ name: 'Fireball', description: 'The wielder\'s basic attack becomes Fireball.' }] },
                { type: 'weapon', id: 103, name: 'Glimmering Dagger', rarity: 'Rare', art: 'https://placehold.co/256x202/facc15/000000?text=Dagger', damage: 3, abilities: [{ name: 'Poison Tip', description: '10% chance to apply Poison on hit.' }] },
            ];

            // --- STATE MANAGEMENT ---
            let team = { hero1: null, weapon1: null, hero2: null, weapon2: null };
            let currentDraftStage = 'HERO_1_PACK';
            let openedPack = [];
            let battleState = [];
            const battleSpeeds = [
                { label: '1x', multiplier: 2 },
                { label: '2x', multiplier: 1 },
                { label: '0.5x', multiplier: 4 }
            ];
            let currentSpeedIndex = 0;

            // --- DOM ELEMENTS ---
            const scenes = {
                pack: document.getElementById('pack-scene'),
                draft: document.getElementById('draft-scene'),
                weapon: document.getElementById('weapon-scene'),
                battle: document.getElementById('battle-scene'),
            };
            const boosterPack = document.getElementById('booster-pack');
            const weaponPack = document.getElementById('weapon-pack');
            const draftPool = document.getElementById('draft-pool');
            const weaponDraftPool = document.getElementById('weapon-draft-pool');
            const confirmationBar = document.getElementById('confirmation-bar');
            const confirmDraftButton = document.getElementById('confirm-draft');
            const playAgainButton = document.getElementById('play-again-button');
            const speedCycleButton = document.getElementById('speed-cycle-button');

            // --- FLOW CONTROL ---
            function transitionToScene(sceneName) {
                Object.values(scenes).forEach(s => s.classList.add('hidden'));
                scenes[sceneName].classList.remove('hidden');
            }

            function advanceDraft() {
                if (currentDraftStage === 'HERO_1_DRAFT' && team.hero1) {
                    currentDraftStage = 'WEAPON_1_DRAFT';
                    resetWeaponScene();
                    transitionToScene('weapon');
                } else if (currentDraftStage === 'WEAPON_1_DRAFT' && team.weapon1) {
                    currentDraftStage = 'HERO_2_PACK';
                    resetPackScene();
                    transitionToScene('pack');
                } else if (currentDraftStage === 'HERO_2_DRAFT' && team.hero2) {
                    currentDraftStage = 'WEAPON_2_DRAFT';
                    resetWeaponScene();
                    transitionToScene('weapon');
                } else if (currentDraftStage === 'WEAPON_2_DRAFT' && team.weapon2) {
                    currentDraftStage = 'DONE';
                    confirmationBar.classList.add('visible');
                }
                updateInstructions();
            }
            
            function updateInstructions() {
                document.getElementById('pack-scene-title').textContent = currentDraftStage === 'HERO_1_PACK' ? 'Open Your Hero Pack' : 'Open Pack for Second Hero';
                document.getElementById('draft-instructions').textContent = `Choose your ${currentDraftStage === 'HERO_1_DRAFT' ? 'first' : 'second'} hero.`;
                const heroName = team.hero1 ? allPossibleHeroes.find(h => h.id === team.hero1).name : 'your hero';
                document.getElementById('weapon-instructions').textContent = `Select a weapon for ${heroName}.`;
            }

            // --- DRAFT LOGIC ---
            function generatePackRarities() {
                const rarities = [];
                for (let i = 0; i < 4; i++) {
                    const roll = Math.random();
                    if (roll < 0.05) rarities.push('Ultra Rare');
                    else if (roll < 0.20) rarities.push('Rare');
                    else if (roll < 0.50) rarities.push('Uncommon');
                    else rarities.push('Common');
                }
                return rarities;
            }

            function openPack(isWeapon = false) {
                const packElement = isWeapon ? weaponPack : boosterPack;
                packElement.style.pointerEvents = 'none';
                packElement.classList.add('opening');
                
                packElement.addEventListener('animationend', () => {
                    if(isWeapon){
                        packElement.style.display = 'none';
                        weaponDraftPool.style.display = 'grid';
                        renderWeaponPool();
                    } else {
                        currentDraftStage = currentDraftStage === 'HERO_1_PACK' ? 'HERO_1_DRAFT' : 'HERO_2_DRAFT';
                        transitionToScene('draft');
                        renderHeroPool();
                    }
                }, { once: true });
            }

            function renderHeroPool() {
                const packRarities = generatePackRarities();
                openedPack = packRarities.map(rarity => {
                    const available = allPossibleHeroes.filter(h => h.rarity === rarity);
                    return available[Math.floor(Math.random() * available.length)];
                });
                openedPack = [...new Map(openedPack.map(item => [item.id, item])).values()];
                 while(openedPack.length < 4) {
                    const fallback = allPossibleHeroes[Math.floor(Math.random() * allPossibleHeroes.length)];
                    if(!openedPack.find(h => h.id === fallback.id)) openedPack.push(fallback);
                }

                draftPool.innerHTML = '';
                openedPack.forEach(hero => {
                    const card = createDetailCard(hero, handleHeroSelection);
                    draftPool.appendChild(card);
                });
            }

            function renderWeaponPool() {
                weaponDraftPool.innerHTML = '';
                const shuffled = [...allPossibleWeapons].sort(() => 0.5 - Math.random());
                const weaponChoices = shuffled.slice(0, 3);
                weaponChoices.forEach(weapon => {
                    const card = createDetailCard(weapon, handleWeaponSelection);
                    weaponDraftPool.appendChild(card);
                });
            }

            function handleHeroSelection(hero) {
                if (currentDraftStage === 'HERO_1_DRAFT') team.hero1 = hero.id;
                else team.hero2 = hero.id;
                advanceDraft();
            }

            function handleWeaponSelection(weapon) {
                if (currentDraftStage === 'WEAPON_1_DRAFT') team.weapon1 = weapon.id;
                else team.weapon2 = weapon.id;
                advanceDraft();
            }
            
            function resetPackScene() {
                boosterPack.classList.remove('opening');
                boosterPack.style.pointerEvents = 'auto';
            }
            function resetWeaponScene() {
                weaponPack.classList.remove('opening');
                weaponPack.style.display = 'flex';
                weaponPack.style.pointerEvents = 'auto';
                weaponDraftPool.style.display = 'none';
            }

            // --- GENERIC CARD CREATION ---
            function createDetailCard(item, selectionHandler) {
                const container = document.createElement('div');
                container.className = 'hero-card-container'; 
                const cardFront = document.createElement('div');
                const rarityClass = item.rarity.toLowerCase().replace(' ', '-');
                cardFront.className = `hero-card ${rarityClass}`;
                
                let statsHtml = item.type === 'hero' ? `
                    <div class="stat-block"><span class="stat-value">${item.hp}</span><span class="stat-label">HP</span></div>
                    <div class="stat-block"><span class="stat-value">${item.attack}</span><span class="stat-label">Attack</span></div>` : `
                    <div class="stat-block"><span class="stat-value">+${item.damage}</span><span class="stat-label">Damage</span></div>`;

                cardFront.innerHTML = `
                    ${item.rarity === 'Ultra Rare' ? '<div class="shimmer-effect"></div>' : ''}
                    <div class="hero-art" style="background-image: url('${item.art}')"></div>
                    <h3 class="hero-name font-cinzel">${item.name}</h3>
                    <div class="hero-stats">${statsHtml}</div>
                    <ul class="hero-abilities">
                        ${item.abilities.map(ab => `<li>${ab.name}<div class="tooltip">${ab.description}</div></li>`).join('')}
                    </ul>`;
                container.appendChild(cardFront);
                cardFront.addEventListener('click', () => selectionHandler(item));
                return container;
            }

            // --- BATTLE LOGIC ---
            
            async function startBattle() {
                confirmationBar.classList.remove('visible');
                transitionToScene('battle');
                const enemyHero1 = allPossibleHeroes[Math.floor(Math.random() * allPossibleHeroes.length)];
                const enemyHero2 = allPossibleHeroes.filter(h => h.id !== enemyHero1.id)[Math.floor(Math.random() * (allPossibleHeroes.length - 1))];
                const enemyWeapon1 = allPossibleWeapons[Math.floor(Math.random() * allPossibleWeapons.length)];
                const enemyWeapon2 = allPossibleWeapons[Math.floor(Math.random() * allPossibleWeapons.length)];
                
                const playerHero1 = allPossibleHeroes.find(h => h.id === team.hero1);
                const playerWeapon1 = allPossibleWeapons.find(w => w.id === team.weapon1);
                const playerHero2 = allPossibleHeroes.find(h => h.id === team.hero2);
                const playerWeapon2 = allPossibleWeapons.find(w => w.id === team.weapon2);
                
                battleState = [
                    { heroData: playerHero1, weaponData: playerWeapon1, team: 'player', position: 0 },
                    { heroData: enemyHero1, weaponData: enemyWeapon1, team: 'enemy', position: 0 },
                    { heroData: playerHero2, weaponData: playerWeapon2, team: 'player', position: 1 },
                    { heroData: enemyHero2, weaponData: enemyWeapon2, team: 'enemy', position: 1 },
                ].map((s, i) => ({
                    ...s,
                    id: `combatant-${i}`,
                    currentHp: s.heroData.hp,
                    maxHp: s.heroData.hp,
                    statusEffects: [],
                    element: null,
                }));

                const playerContainer = document.getElementById('player-team-container');
                const enemyContainer = document.getElementById('enemy-team-container');
                playerContainer.innerHTML = '';
                enemyContainer.innerHTML = '';
                battleState.forEach(combatant => {
                    const card = createCompactCard(combatant);
                    combatant.element = card;
                    if (combatant.team === 'player') playerContainer.appendChild(card);
                    else enemyContainer.appendChild(card);
                });

                await sleep(125 * battleSpeeds[currentSpeedIndex].multiplier); 
                runCombatTurn(0);
            }

            let currentAttackerIndex = 0;
            async function runCombatTurn() {
                const attacker = battleState[currentAttackerIndex];
                
                if(attacker.currentHp <= 0) {
                    currentAttackerIndex = (currentAttackerIndex + 1) % 4;
                    runCombatTurn();
                    return;
                }

                const stunEffect = attacker.statusEffects.find(e => e.name === 'Stun');
                if(stunEffect) {
                    logToBattle(`${attacker.heroData.name} is stunned and skips their turn!`);
                    stunEffect.turnsRemaining--;
                    if(stunEffect.turnsRemaining <= 0) attacker.statusEffects = attacker.statusEffects.filter(e => e.name !== 'Stun');
                    updateStatusIcons(attacker);
                    await sleep(125 * battleSpeeds[currentSpeedIndex].multiplier);
                    currentAttackerIndex = (currentAttackerIndex + 1) % 4;
                    runCombatTurn();
                    return;
                }
                
                const enemies = battleState.filter(c => c.team !== attacker.team && c.currentHp > 0);
                if(enemies.length === 0) return; 
                const target = enemies.sort((a,b) => a.position - b.position)[0];

                let action = 'basic_attack';
                if(attacker.heroData.name === 'Warrior' && !target.statusEffects.some(e => e.name === 'Stun')) action = 'Shield Bash';
                if(attacker.heroData.name === 'Champion' && enemies.length > 1) action = 'Whirlwind';
                
                attacker.element.classList.add('is-attacking');
                await sleep(67 * battleSpeeds[currentSpeedIndex].multiplier);

                switch(action) {
                    case 'Whirlwind':
                        logToBattle(`${attacker.heroData.name} uses Whirlwind!`);
                        for(const enemy of enemies) {
                            dealDamage(attacker, enemy, 4, false);
                        }
                        break;
                    case 'Shield Bash':
                        logToBattle(`${attacker.heroData.name} uses Shield Bash!`);
                        dealDamage(attacker, target, 1, false);
                        applyStatus(target, 'Stun', 1);
                        break;
                    default: 
                        let damage = attacker.heroData.attack + attacker.weaponData.damage;
                        let attackName = attacker.weaponData.name;
                        if(attacker.heroData.name === 'Champion') attackName = 'Execute';

                        logToBattle(`${attacker.heroData.name} attacks ${target.heroData.name} with ${attackName}!`);
                        dealDamage(attacker, target, damage, true);
                        
                        if(attacker.weaponData.name === 'Iron Sword' && enemies.length > 1) {
                            const secondTarget = enemies.find(e => e.id !== target.id);
                            if(secondTarget) {
                                logToBattle(`Cleave hits ${secondTarget.heroData.name}!`);
                                dealDamage(attacker, secondTarget, Math.ceil(damage * 0.5), false);
                            }
                        }
                        if(attacker.weaponData.name === 'Glimmering Dagger' && Math.random() < 0.10){
                            applyStatus(target, 'Poison', Math.floor(Math.random() * 3) + 2); 
                        }
                }
                
                await sleep(100 * battleSpeeds[currentSpeedIndex].multiplier);
                attacker.element.classList.remove('is-attacking');

                const isPlayerTeamDefeated = battleState.filter(c => c.team === 'player' && c.currentHp > 0).length === 0;
                const isEnemyTeamDefeated = battleState.filter(c => c.team === 'enemy' && c.currentHp > 0).length === 0;

                if(isPlayerTeamDefeated || isEnemyTeamDefeated) {
                    endBattle(!isPlayerTeamDefeated);
                    return;
                }

                currentAttackerIndex = (currentAttackerIndex + 1) % 4;
                setTimeout(runCombatTurn, 167 * battleSpeeds[currentSpeedIndex].multiplier);
            }
            
            function dealDamage(attacker, target, amount, isBasicAttack) {
                if(target.heroData.abilities.some(a => a.name === 'Fortify')) amount = Math.max(0, amount - 1);
                target.currentHp = Math.max(0, target.currentHp - amount);
                
                target.element.classList.add('is-taking-damage');
                setTimeout(() => target.element.classList.remove('is-taking-damage'), 67 * battleSpeeds[currentSpeedIndex].multiplier);
                showDamagePopup(target.element, amount);
                updateHealthBar(target);

                if (target.currentHp <= 0) {
                    logToBattle(`${target.heroData.name} has been defeated!`);
                    target.element.classList.add('is-defeated');
                }
            }

            function applyStatus(target, statusName, duration){
                 logToBattle(`${target.heroData.name} is afflicted with ${statusName}!`);
                 target.statusEffects.push({name: statusName, turnsRemaining: duration});
                 updateStatusIcons(target);
            }

            function endBattle(didPlayerWin) {
                const endScreen = document.getElementById('end-screen');
                const resultText = document.getElementById('end-screen-result-text');
                const resultsContainer = document.getElementById('end-screen-results');
                
                logToBattle(didPlayerWin ? "Player team is victorious!" : "Enemy team is victorious!");

                endScreen.className = didPlayerWin ? 'victory' : 'defeat';
                resultText.textContent = didPlayerWin ? 'Victory' : 'Defeat';

                resultsContainer.innerHTML = '';
                battleState.filter(c => c.team === 'player').forEach(c => {
                    const card = createCompactCard(c);
                    if(c.currentHp <= 0) card.classList.add('is-defeated');
                    resultsContainer.appendChild(card);
                });

                setTimeout(() => endScreen.classList.add('visible'), 167 * battleSpeeds[currentSpeedIndex].multiplier);
            }
            
            function createCompactCard(combatant) {
                const card = document.createElement('div');
                const rarityClass = combatant.heroData.rarity.toLowerCase().replace(' ', '-');
                card.id = combatant.id;
                card.className = `compact-card ${rarityClass}`;
                card.innerHTML = `
                    <div class="compact-art" style="background-image: url('${combatant.heroData.art}')"></div>
                    <div class="compact-info">
                        <div class="compact-name font-cinzel">${combatant.heroData.name}</div>
                        <div class="hp-text">${combatant.currentHp} / ${combatant.maxHp}</div>
                        <div class="compact-hp-bar-container">
                            <div class="compact-hp-bar"></div>
                        </div>
                    </div>
                    <div class="status-icon-container"></div>
                `;
                updateHealthBar(combatant, card);
                return card;
            }

            function updateHealthBar(combatant, cardElement = null) {
                const card = cardElement || combatant.element;
                const bar = card.querySelector('.compact-hp-bar');
                const hpText = card.querySelector('.hp-text');
                const percentage = (combatant.currentHp / combatant.maxHp) * 100;
                bar.style.width = `${percentage}%`;
                bar.style.backgroundColor = percentage > 50 ? '#48bb78' : percentage > 20 ? '#f59e0b' : '#ef4444';
                hpText.textContent = `${combatant.currentHp} / ${combatant.maxHp}`;
            }

            function showDamagePopup(targetElement, amount) {
                const popup = document.createElement('div');
                popup.className = 'damage-popup';
                popup.textContent = amount;
                targetElement.appendChild(popup);
                setTimeout(() => popup.remove(), 234 * battleSpeeds[currentSpeedIndex].multiplier);
            }

            function updateStatusIcons(combatant){
                const container = combatant.element.querySelector('.status-icon-container');
                container.innerHTML = '';
                combatant.statusEffects.forEach(effect => {
                    const icon = document.createElement('div');
                    icon.className = 'status-icon';
                    icon.innerHTML = effect.name === 'Stun' ? '<i class="fa-solid fa-star"></i>' : '<i class="fa-solid fa-skull-crossbones"></i>';
                    icon.title = `${effect.name} (${effect.turnsRemaining} turns left)`;
                    container.appendChild(icon);
                });
            }

            function logToBattle(message) {
                const log = document.getElementById('battle-log');
                log.textContent = message;
                log.style.opacity = '1';
                setTimeout(() => log.style.opacity = '0', 667 * battleSpeeds[currentSpeedIndex].multiplier);
            }

            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            // --- EVENT LISTENERS ---
            boosterPack.addEventListener('click', () => openPack(false));
            weaponPack.addEventListener('click', () => openPack(true));
            confirmDraftButton.addEventListener('click', startBattle);
            playAgainButton.addEventListener('click', () => window.location.reload());
            speedCycleButton.addEventListener('click', () => {
                currentSpeedIndex = (currentSpeedIndex + 1) % battleSpeeds.length;
                const newSpeed = battleSpeeds[currentSpeedIndex];
                speedCycleButton.textContent = `Speed: ${newSpeed.label}`;
            });
            
            // --- INITIALIZE ---
            updateInstructions();
        });
    </script>
</body>
</html>
